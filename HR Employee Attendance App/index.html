<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HR Portal ‚Äì Timesheet & Attendance (Roles)</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary:#2563eb;--accent:#10b981;--danger:#ef4444;
  --sidebar-bg:#1e293b;--sidebar-hover:#334155;
  --bg:#f8fafc;--text:#1e293b;--card:#ffffff;--border:#e2e8f0;
}
*{box-sizing:border-box}
body{margin:0;height:100vh;display:flex;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Arial,sans-serif;overflow:hidden}
.sidebar{width:240px;background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;padding:1rem}
.sidebar h2{margin:0 0 1.5rem;text-align:center;font-weight:700}
.nav-item{padding:.75rem 1rem;border-radius:8px;margin-bottom:.5rem;cursor:pointer}
.nav-item:hover,.nav-item.active{background:var(--sidebar-hover)}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
header{background:var(--card);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 6px rgba(0,0,0,.05)}
header h1{color:var(--primary);font-size:1.25rem;margin:0}
header img{height:40px}
.userbox{display:flex;gap:8px;align-items:center}
.role-tag{padding:2px 8px;border-radius:999px;background:#e2e8f0;font-size:.8rem}
.content{flex:1;overflow:auto;padding:1.25rem 2rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03);padding:1.25rem;margin-bottom:1rem}
input,select,button{border:1px solid var(--border);border-radius:8px;padding:.6rem .8rem;font-size:.95rem}
button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
button:hover{background:#1d4ed8}
button[disabled]{opacity:.6;cursor:not-allowed}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;margin-top:.75rem}
th,td{padding:.7rem;border-bottom:1px solid var(--border);text-align:center}
th{background:#f1f5f9;font-weight:600;color:#334155}
.hidden{display:none}
.grid{display:grid;gap:10px}
.grid-6{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.summary{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.summary .card{flex:1 1 240px;text-align:center;background:#f9fafb}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.emp-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.emp-card{background:#0b1220;color:#fff;border-radius:12px;padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
.emp-card:hover{background:#111a2b}
.badge{background:#0ea5e9;color:#fff;border-radius:999px;padding:.15rem .5rem;font-size:.75rem}
.small{font-size:.85rem;color:#64748b}
.inline{display:inline-flex;align-items:center;gap:8px}
input[type="number"]{max-width:120px}
.settings-grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.settings-grid{grid-template-columns:1fr 2fr}}
.table-compact th,.table-compact td{padding:.55rem}
hr.div{border:none;border-top:1px dashed var(--border);margin:.75rem 0}
select.role{min-width:140px}
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <h2>HR Portal</h2>
  <div class="nav-item active" data-page="dashboard">üìä Dashboard</div>
  <div class="nav-item" data-page="attendance">üïí Attendance</div>
  <div class="nav-item" data-page="reports">üìà Reports</div>
  <div class="nav-item" data-page="settings">‚öôÔ∏è Settings</div>
</div>

<!-- Main -->
<div class="main">
  <header>
    <h1>Employee Timesheet Tracker</h1>
    <div class="userbox">
      <span id="currentUserName">‚Äî</span>
      <span id="currentUserRole" class="role-tag">‚Äî</span>
      <button id="switchUserBtn" style="background:#0ea5e9">Switch User</button>
    </div>
  </header>

  <div class="content">
    <!-- Dashboard -->
    <section id="dashboard" class="page">
      <div class="card">
        <h3 style="margin-top:0">Add Timesheet Entry</h3>
        <div class="grid grid-6">
          <input type="date" id="dateInput" />
          <input type="text" id="nameInput" placeholder="Employee name" />
          <input type="time" id="timeInInput" />
          <input type="time" id="timeOutInput" />
          <input type="number" id="breakInput" step="0.25" min="0" value="1" placeholder="Break (hrs)" />
          <button id="addBtn">Add</button>
        </div>
        <p id="dashboardHelp" class="small" style="margin-top:.5rem"></p>
      </div>

      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Monthly Records</h3>
          <div class="inline">
            <select id="monthSelect"></select>
            <select id="yearSelect"></select>
            <button id="filterBtn">View</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Employee</th><th>Time In</th><th>Time Out</th>
                <th>Break (hrs)</th><th>Day Total (hrs)</th><th id="actionsHeader">Action</th>
              </tr>
            </thead>
            <tbody id="timesheetTable"></tbody>
          </table>
        </div>

        <div class="flex" style="justify-content:center;margin-top:10px">
          <button id="downloadBtn" style="background:var(--accent)">üì• Export CSV</button>
          <label for="importFile" id="importLabel" style="background:var(--accent);color:#fff;border-radius:8px;cursor:pointer;padding:.6rem .8rem">üìÇ Import CSV</label>
          <input type="file" id="importFile" accept=".csv" class="hidden">
        </div>
      </div>
    </section>

    <!-- Attendance -->
    <section id="attendance" class="page hidden">
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Attendance (Clock In / Clock Out)</h3>
          <div class="inline" id="addEmpBlock">
            <input type="text" id="newEmployeeInput" placeholder="Add employee name" />
            <button id="addEmployeeBtn" style="background:#0ea5e9">Add Employee</button>
          </div>
        </div>
        <p class="small">Click an employee to open their attendance panel. Clock-in/out uses the current time.</p>
        <div id="employeeList" class="emp-list"></div>
      </div>

      <div id="empPanel" class="card hidden">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <div class="inline">
            <h3 id="empTitle" style="margin:0"></h3>
            <span id="empClockStatus" class="badge">Idle</span>
          </div>
          <div class="inline">
            <span class="small">Employee break default (hrs):</span>
            <input type="number" id="empBreakDefault" step="0.25" min="0" value="1" />
          </div>
        </div>
        <div class="flex">
          <div class="card" style="flex:1">
            <div class="small">Today</div>
            <div id="todayStr" style="font-weight:700"></div>
            <div class="small" id="nowStr"></div>
            <div class="flex" style="margin-top:10px">
              <button id="clockInBtn">üü¢ Clock In (Now)</button>
              <button id="clockOutBtn">üî¥ Clock Out (Now)</button>
              <button id="deleteEmpBtn" style="background:#dc2626">üóë Delete Employee</button>
              <button id="closePanelBtn" style="background:#475569">Close</button>
            </div>
          </div>
          <div class="card" style="flex:2">
            <div class="inline" style="justify-content:space-between;width:100%">
              <div class="small">Recent Entries</div>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Date</th><th>Time In</th><th>Time Out</th><th>Break</th><th>Day Total</th></tr></thead>
                <tbody id="empRows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports" class="page hidden">
      <div class="card">
        <h3>Employee Analytics</h3>
        <div class="inline">
          <select id="employeeSelect"></select>
          <button id="updateChartsBtn">View Analytics</button>
        </div>
        <canvas id="barChart"></canvas>
        <canvas id="pieChart"></canvas>
        <canvas id="monthChart"></canvas>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="page hidden">
      <div class="settings-grid">
        <div class="card">
          <h3 style="margin-top:0">Company Defaults</h3>
          <div class="inline">
            <label class="small">Company-wide default break (hrs):</label>
            <input type="number" id="companyBreakInput" step="0.25" min="0" />
            <button id="saveCompanyBreakBtn" style="background:var(--accent)">Save</button>
          </div>
          <hr class="div" />
          <h3 style="margin-top:.25rem">User Management</h3>
          <div class="inline" style="flex-wrap:wrap">
            <input type="text" id="userNameInput" placeholder="Name (e.g., Riz Rim)" />
            <select id="userRoleInput" class="role">
              <option value="admin">Admin</option>
              <option value="employee">Employee</option>
            </select>
            <button id="addUserBtn">Add User</button>
          </div>
          <div class="table-wrap" style="margin-top:.5rem">
            <table class="table-compact">
              <thead><tr><th style="text-align:left">Name</th><th>Role</th><th>Actions</th></tr></thead>
              <tbody id="userTable"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Employee Overrides</h3>
          <div class="table-wrap">
            <table class="table-compact">
              <thead><tr><th style="text-align:left">Employee</th><th>Break Default (hrs)</th><th>Action</th></tr></thead>
              <tbody id="settingsEmpTable"></tbody>
            </table>
          </div>
          <p class="small">Admins can adjust per-employee defaults here.</p>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  /* ======= State ======= */
  let entries = JSON.parse(localStorage.getItem("timesheetData")) || [];
  let employees = JSON.parse(localStorage.getItem("employees")) || ["Riz Rim","Alex Tan","Maya Chen"];
  let sessions = JSON.parse(localStorage.getItem("clockSessions")) || {};
  let companyBreakDefault = parseFloat(localStorage.getItem("companyBreakDefault")); if(isNaN(companyBreakDefault)) companyBreakDefault = 1.0;
  let employeeBreaks = JSON.parse(localStorage.getItem("employeeBreaks")) || {};
  let users = JSON.parse(localStorage.getItem("users")) || [
    { name:"Admin", role:"admin" },
    { name:"Riz Rim", role:"employee" }
  ];
  let currentUser = JSON.parse(localStorage.getItem("currentUser")) || users[0];

  /* ======= Helpers ======= */
  const $ = id=>document.getElementById(id);
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const pad = n=>String(n).padStart(2,"0");
  const nowParts = ()=>{const d=new Date();return {date:`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`,time:`${pad(d.getHours())}:${pad(d.getMinutes())}`};};
  const getBreakFor = name => {const v=parseFloat(employeeBreaks[name]);return isNaN(v)?companyBreakDefault:v;};
  const isAdmin = ()=> currentUser?.role === "admin";
  const isEmployee = ()=> currentUser?.role === "employee";

  /* ======= UI: Header User Box ======= */
  const currentUserNameEl = $("currentUserName");
  const currentUserRoleEl = $("currentUserRole");
  const switchUserBtn = $("switchUserBtn");

  function updateUserHeader(){
    currentUserNameEl.textContent = currentUser?.name || "‚Äî";
    currentUserRoleEl.textContent = currentUser?.role || "‚Äî";
  }
  function switchUser(){
    // Simple prompt-based switcher (no passwords for intranet test)
    const names = users.map(u=>u.name).join(", ");
    const picked = prompt(`Enter user name to sign in:\n(${names})\n\nOr type a new name to create as Employee.`);
    if(!picked) return;
    let user = users.find(u=>u.name.toLowerCase()===picked.toLowerCase());
    if(!user){
      user = { name:picked, role:"employee" };
      users.push(user); save("users", users);
      if(!employees.includes(picked)){ employees.push(picked); save("employees",employees); }
    }
    currentUser = user; save("currentUser", currentUser);
    applyPermissions();
    renderAll();
    alert(`Signed in as ${currentUser.name} (${currentUser.role})`);
  }
  switchUserBtn.onclick = switchUser;

  /* ======= NAV ======= */
  const pages=document.querySelectorAll(".page");
  document.querySelectorAll(".nav-item").forEach(nav=>{
    nav.onclick=()=>{
      document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
      nav.classList.add("active");
      pages.forEach(p=>p.classList.add("hidden"));
      $(nav.dataset.page).classList.remove("hidden");
      // contextual refresh
      if(nav.dataset.page==="attendance"){renderEmployeeList();closeEmployeePanel(true);}
      if(nav.dataset.page==="settings"){renderSettings();renderUsers();}
      if(nav.dataset.page==="reports"){refreshEmployeeListForReports();}
      if(nav.dataset.page==="dashboard"){renderTable();}
    };
  });

  /* ======= DASHBOARD ======= */
  const dateInput=$("dateInput"),nameInput=$("nameInput"),timeInInput=$("timeInInput"),timeOutInput=$("timeOutInput"),breakInput=$("breakInput"),addBtn=$("addBtn"),
        monthSelect=$("monthSelect"),yearSelect=$("yearSelect"),filterBtn=$("filterBtn"),tableBody=$("timesheetTable"),
        totalHoursEl=$("totalHours"),absentDaysEl=$("absentDays"),summaryMonthEl=$("summaryMonth"),
        downloadBtn=$("downloadBtn"),importFile=$("importFile"),importLabel=$("importLabel"),actionsHeader=$("actionsHeader"),dashboardHelp=$("dashboardHelp");

  function initMonthYear(){
    const now=new Date();
    monthSelect.innerHTML=""; yearSelect.innerHTML="";
    months.forEach((m,i)=>{const o=document.createElement("option");o.value=i+1;o.textContent=m;if(i===now.getMonth())o.selected=true;monthSelect.appendChild(o);});
    for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){const o=document.createElement("option");o.value=y;o.textContent=y;if(y===now.getFullYear())o.selected=true;yearSelect.appendChild(o);}
  }
  initMonthYear();

  function renderTable(){
    const m=parseInt(monthSelect.value),y=parseInt(yearSelect.value);
    let filtered = entries.filter(e=>{const d=new Date(e.Date);return d.getMonth()+1===m&&d.getFullYear()===y;});
    // Employees only see their own rows
    if(isEmployee()){ filtered = filtered.filter(e=>e["Employee Name"]===currentUser.name); }
    tableBody.innerHTML=""; let total=0;
    filtered.forEach((e,i)=>{
      const tr=document.createElement("tr");
      const actionCell = isAdmin() ? `<td><button class="delete-btn" data-i="${i}">Delete</button></td>` : `<td>‚Äî</td>`;
      tr.innerHTML=`<td>${e.Date}</td><td>${e["Employee Name"]}</td><td>${e["Time In"]}</td><td>${e["Time Out"]}</td><td>${e.Break}</td><td>${e["Day Total"]}</td>${actionCell}`;
      tableBody.appendChild(tr);
      total+=parseFloat(e["Day Total"]);
    });
    totalHoursEl.textContent=`${total.toFixed(2)} hrs`;
    const daysInMonth=new Date(y,m,0).getDate();
    const workedDays=[...new Set(filtered.map(e=>e.Date))].length;
    absentDaysEl.textContent=Math.max(0,daysInMonth-workedDays);
    summaryMonthEl.textContent=`${months[m-1]} ${y}`;

    if(isAdmin()){
      tableBody.querySelectorAll(".delete-btn").forEach((btn,rowIndex)=>{
        btn.onclick=()=>{
          // map visible index to real index
          const idxMap = entries
            .map((e,idx)=>({e,idx}))
            .filter(({e})=>{const d=new Date(e.Date);return d.getMonth()+1===m&&d.getFullYear()===y && (isAdmin() || e["Employee Name"]===currentUser.name);})
            .map(x=>x.idx);
          entries.splice(idxMap[rowIndex],1); save("timesheetData",entries); renderTable();
        };
      });
    }
  }

  addBtn.onclick=()=>{
    const date=dateInput.value,name=isAdmin()?nameInput.value.trim():currentUser.name,
          timeIn=timeInInput.value,timeOut=timeOutInput.value,b=parseFloat(breakInput.value)||0;
    if(!date||!name||!timeIn||!timeOut)return alert("Please fill all fields!");
    const inT=new Date(`1970-01-01T${timeIn}:00`),outT=new Date(`1970-01-01T${timeOut}:00`);
    let diff=(outT-inT)/(1000*60*60); if(diff<=0)return alert("Time Out must be after Time In!");
    diff-=b; if(diff<0)diff=0;
    entries.push({Date:date,"Employee Name":name,"Time In":timeIn,"Time Out":timeOut,Break:b.toFixed(2),"Day Total":diff.toFixed(2)});
    save("timesheetData",entries);
    if(!employees.includes(name)){employees.push(name);save("employees",employees);}
    renderTable(); if(isAdmin()) nameInput.value=""; dateInput.value=timeInInput.value=timeOutInput.value="";
  };

  downloadBtn.onclick=()=>{ if(!isAdmin()) return; if(!entries.length)return alert("No data to export!"); const ws=XLSX.utils.json_to_sheet(entries); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Timesheet"); XLSX.writeFile(wb,"Timesheet_Export.csv"); };
  importFile.onchange=e=>{
    if(!isAdmin()) return;
    const f=e.target.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{
      const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
      entries=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      save("timesheetData",entries);
      const names=[...new Set(entries.map(x=>x["Employee Name"]).filter(Boolean))];
      employees=[...new Set([...employees,...names])]; save("employees",employees);
      renderTable(); renderEmployeeList(); renderSettings();
    };
    r.readAsArrayBuffer(f);
  };
  filterBtn.onclick=renderTable;

  /* ======= ATTENDANCE ======= */
  const employeeListEl=$("employeeList"),empPanel=$("empPanel"),empTitle=$("empTitle"),empClockStatus=$("empClockStatus"),
        empRows=$("empRows"),empBreakDefaultInput=$("empBreakDefault"),clockInBtn=$("clockInBtn"),clockOutBtn=$("clockOutBtn"),
        closePanelBtn=$("closePanelBtn"),deleteEmpBtn=$("deleteEmpBtn"),todayStr=$("todayStr"),nowStr=$("nowStr"),
        newEmployeeInput=$("newEmployeeInput"),addEmployeeBtn=$("addEmployeeBtn"),addEmpBlock=$("addEmpBlock");
  let currentEmployeePanel=null;

  function renderEmployeeList(){
    employeeListEl.innerHTML="";
    let list = [...employees];
    if(isEmployee()){ list = list.filter(n=>n===currentUser.name); }
    list.forEach(name=>{
      const card=document.createElement("div"); card.className="emp-card";
      const active=sessions[name]?`<span class="badge">Clocked In</span>`:`<span class="badge" style="background:#64748b">Idle</span>`;
      card.innerHTML=`<div>${name}</div>${active}`;
      card.onclick=()=>openEmployeePanel(name);
      employeeListEl.appendChild(card);
    });
    // Add controls visibility
    addEmpBlock.classList.toggle("hidden", !isAdmin());
  }

  addEmployeeBtn.onclick=()=>{
    if(!isAdmin()) return;
    const n=newEmployeeInput.value.trim(); if(!n) return;
    if(!employees.includes(n)){ employees.push(n); save("employees",employees); }
    if(!users.find(u=>u.name===n)) { users.push({name:n, role:"employee"}); save("users",users); }
    newEmployeeInput.value=""; renderEmployeeList(); renderSettings(); renderUsers();
  };

  function openEmployeePanel(name){
    currentEmployeePanel=name;
    empTitle.textContent=name;
    empBreakDefaultInput.value=getBreakFor(name).toFixed(2);
    empBreakDefaultInput.disabled = !isAdmin(); // employees cannot change defaults
    const d=new Date();
    todayStr.textContent=`${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    nowStr.textContent=`Now: ${d.toLocaleTimeString()}`;
    updateClockStatus();
    empPanel.classList.remove("hidden");
    renderEmployeeRows();
    deleteEmpBtn.disabled = !isAdmin();
  }
  function closeEmployeePanel(hideOnly=false){ if(hideOnly){empPanel.classList.add("hidden"); currentEmployeePanel=null; return;} empPanel.classList.add("hidden"); currentEmployeePanel=null; }
  closePanelBtn.onclick=()=>closeEmployeePanel();

  function updateClockStatus(){
    const ses=sessions[currentEmployeePanel];
    if(ses){ empClockStatus.textContent=`Clocked In @ ${ses.timeIn}`; empClockStatus.style.background="#10b981"; }
    else { empClockStatus.textContent="Idle"; empClockStatus.style.background="#64748b"; }
  }

  empBreakDefaultInput.onchange=()=>{
    if(!isAdmin()) return;
    if(!currentEmployeePanel) return;
    const v=parseFloat(empBreakDefaultInput.value); if(!isNaN(v)){ employeeBreaks[currentEmployeePanel]=v; save("employeeBreaks",employeeBreaks); }
  };

  clockInBtn.onclick=()=>{
    if(!currentEmployeePanel) return;
    if(isEmployee() && currentEmployeePanel !== currentUser.name) return alert("You can only clock yourself.");
    const {date,time}=nowParts();
    if(sessions[currentEmployeePanel] && sessions[currentEmployeePanel].date===date) return alert("Already clocked in today.");
    if(entries.some(e=>e["Employee Name"]===currentEmployeePanel && e.Date===date)) return alert("Today's entry already exists.");
    sessions[currentEmployeePanel]={date,timeIn:time}; save("clockSessions",sessions);
    updateClockStatus(); renderEmployeeList();
  };

  clockOutBtn.onclick=()=>{
    if(!currentEmployeePanel) return;
    if(isEmployee() && currentEmployeePanel !== currentUser.name) return alert("You can only clock yourself.");
    const {date,time}=nowParts(); const ses=sessions[currentEmployeePanel];
    if(!ses || ses.date!==date) return alert("No active clock-in found for today.");
    const inTime=new Date(`1970-01-01T${ses.timeIn}:00`),outTime=new Date(`1970-01-01T${time}:00`);
    let diff=(outTime-inTime)/(1000*60*60); if(diff<=0) return alert("Clock out must be after clock in.");
    const b=getBreakFor(currentEmployeePanel); diff-=b; if(diff<0) diff=0;
    entries.push({Date:date,"Employee Name":currentEmployeePanel,"Time In":ses.timeIn,"Time Out":time,Break:b.toFixed(2),"Day Total":diff.toFixed(2)});
    save("timesheetData",entries);
    delete sessions[currentEmployeePanel]; save("clockSessions",sessions);
    updateClockStatus(); renderEmployeeRows(); renderEmployeeList(); renderTable();
  };

  deleteEmpBtn.onclick=()=>{
    if(!isAdmin()) return;
    if(!currentEmployeePanel) return;
    if(!confirm(`Delete ${currentEmployeePanel} and all related records?`)) return;
    employees = employees.filter(e=>e!==currentEmployeePanel);
    delete sessions[currentEmployeePanel];
    delete employeeBreaks[currentEmployeePanel];
    entries = entries.filter(e=>e["Employee Name"]!==currentEmployeePanel);
    users = users.filter(u=>u.name!==currentEmployeePanel); // also remove from users
    save("employees",employees); save("clockSessions",sessions); save("employeeBreaks",employeeBreaks); save("timesheetData",entries); save("users",users);
    alert(`${currentEmployeePanel} deleted.`);
    renderEmployeeList(); renderSettings(); renderUsers(); renderTable();
    closeEmployeePanel();
  };

  function renderEmployeeRows(){
    if(!currentEmployeePanel){empRows.innerHTML="";return;}
    let rows=entries.filter(e=>e["Employee Name"]===currentEmployeePanel).sort((a,b)=>new Date(a.Date)-new Date(b.Date));
    empRows.innerHTML = rows.map(r=>`<tr><td>${r.Date}</td><td>${r["Time In"]}</td><td>${r["Time Out"]}</td><td>${r.Break}</td><td>${r["Day Total"]}</td></tr>`).join("")
      || `<tr><td colspan="5" class="small">No entries yet.</td></tr>`;
  }

  /* ======= REPORTS ======= */
  const employeeSelect=$("employeeSelect"),updateChartsBtn=$("updateChartsBtn");
  let barChart,pieChart,monthChart;
  function refreshEmployeeListForReports(){
    if(!isAdmin()){ employeeSelect.innerHTML=`<option>${currentUser.name}</option>`; return; }
    const list=[...new Set(entries.map(e=>e["Employee Name"]))].sort();
    employeeSelect.innerHTML=`<option value="all">All Employees</option>`;
    list.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;employeeSelect.appendChild(o);});
  }
  function destroyCharts(){ if(barChart)barChart.destroy(); if(pieChart)pieChart.destroy(); if(monthChart)monthChart.destroy(); }
  function updateCharts(){
    const target = isAdmin() ? employeeSelect.value : currentUser.name;
    let dataFiltered = target==="all" ? entries : entries.filter(e=>e["Employee Name"]===target);
    if(!dataFiltered.length){destroyCharts();return;}
    const now=new Date(),cm=now.getMonth()+1,cy=now.getFullYear();
    const md=dataFiltered.filter(e=>{const d=new Date(e.Date);return d.getMonth()+1===cm&&d.getFullYear()===cy;});
    const dayTotals={}; md.forEach(e=>{const d=new Date(e.Date).getDate(); dayTotals[d]=(dayTotals[d]||0)+parseFloat(e["Day Total"]);});
    const labels=Object.keys(dayTotals).sort((a,b)=>a-b), data=labels.map(k=>dayTotals[k]);
    const workedDays=labels.length, daysInMonth=new Date(cy,cm,0).getDate(), abs=daysInMonth-workedDays;
    const mmTotals={}; dataFiltered.forEach(e=>{const d=new Date(e.Date); const key=`${d.getFullYear()}-${d.getMonth()+1}`; mmTotals[key]=(mmTotals[key]||0)+parseFloat(e["Day Total"]);});
    const mLabels=Object.keys(mmTotals).sort(), mData=mLabels.map(k=>mmTotals[k]);

    destroyCharts();
    barChart=new Chart($("barChart"),{type:"bar",data:{labels,datasets:[{label:"Daily Hours",data,backgroundColor:"#2563eb"}]},options:{scales:{y:{beginAtZero:true}}}});
    pieChart=new Chart($("pieChart"),{type:"pie",data:{labels:["Worked","Absent"],datasets:[{data:[workedDays,abs],backgroundColor:["#10b981","#ef4444"]}]}});
    monthChart=new Chart($("monthChart"),{type:"bar",data:{labels:mLabels.map(k=>{const[yy,mm]=k.split("-");return `${months[mm-1]} ${yy}`;}),datasets:[{label:"Monthly Hours",data:mData,backgroundColor:"#0ea5e9"}]},options:{scales:{y:{beginAtZero:true}}}});
  }
  updateChartsBtn.onclick=updateCharts;

  /* ======= SETTINGS ======= */
  const companyBreakInput=$("companyBreakInput"),saveCompanyBreakBtn=$("saveCompanyBreakBtn"),settingsEmpTable=$("settingsEmpTable");
  const userNameInput=$("userNameInput"),userRoleInput=$("userRoleInput"),addUserBtn=$("addUserBtn"),userTable=$("userTable");

  function renderSettings(){
    companyBreakInput.value=Number(companyBreakDefault).toFixed(2);
    // Only admins can edit
    companyBreakInput.disabled = !isAdmin();
    saveCompanyBreakBtn.disabled = !isAdmin();

    // Employee overrides table
    const names=[...employees].sort();
    settingsEmpTable.innerHTML = names.map(n=>{
      const val=getBreakFor(n).toFixed(2);
      const disabled = !isAdmin() ? "disabled" : "";
      const actions = isAdmin()
        ? `<button data-emp="${encodeURIComponent(n)}" class="empBreakSaveBtn" style="background:var(--accent)">Save</button>
           <button data-emp="${encodeURIComponent(n)}" class="empBreakClearBtn" style="background:#64748b">Clear</button>`
        : "‚Äî";
      return `<tr>
        <td style="text-align:left">${n}</td>
        <td><input ${disabled} type="number" step="0.25" min="0" value="${val}" data-emp="${encodeURIComponent(n)}" class="empBreakInput"/></td>
        <td>${actions}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="3" class="small">No employees yet.</td></tr>`;

    if(isAdmin()){
      settingsEmpTable.querySelectorAll(".empBreakSaveBtn").forEach(btn=>{
        btn.onclick=()=>{
          const name=decodeURIComponent(btn.getAttribute("data-emp"));
          const inp=settingsEmpTable.querySelector(`.empBreakInput[data-emp="${encodeURIComponent(name)}"]`);
          const v=parseFloat(inp.value); if(isNaN(v)) return;
          employeeBreaks[name]=v; save("employeeBreaks",employeeBreaks); alert(`Saved ${name}'s break = ${v} hrs`);
        };
      });
      settingsEmpTable.querySelectorAll(".empBreakClearBtn").forEach(btn=>{
        btn.onclick=()=>{ const name=decodeURIComponent(btn.getAttribute("data-emp")); delete employeeBreaks[name]; save("employeeBreaks",employeeBreaks); renderSettings(); };
      });
    }
  }
  saveCompanyBreakBtn.onclick=()=>{ if(!isAdmin()) return; const v=parseFloat(companyBreakInput.value); if(isNaN(v)||v<0) return alert("Enter a valid number."); companyBreakDefault=v; save("companyBreakDefault",v); alert(`Company default break set to ${v} hrs`); };

  // User management
  function renderUsers(){
    userTable.innerHTML = users.map((u,i)=>{
      const roleSelect = isAdmin()
        ? `<select data-i="${i}" class="role">
             <option value="admin" ${u.role==="admin"?"selected":""}>Admin</option>
             <option value="employee" ${u.role==="employee"?"selected":""}>Employee</option>
           </select>`
        : `<span class="role-tag">${u.role}</span>`;
      const actions = isAdmin()
        ? `<button data-i="${i}" class="makeCurrentBtn">Sign In</button>
           <button data-i="${i}" class="removeUserBtn" style="background:#dc2626">Remove</button>`
        : (u.name===currentUser.name ? `<span class="small">This is you</span>` : "‚Äî");
      return `<tr><td style="text-align:left">${u.name}</td><td>${roleSelect}</td><td>${actions}</td></tr>`;
    }).join("") || `<tr><td colspan="3" class="small">No users.</td></tr>`;

    if(isAdmin()){
      userTable.querySelectorAll(".role").forEach(sel=>{
        sel.onchange=()=>{ const i=parseInt(sel.getAttribute("data-i")); users[i].role=sel.value; save("users",users); if(users[i].name===currentUser.name){ currentUser.role=sel.value; save("currentUser",currentUser); applyPermissions(); renderAll(); } };
      });
      userTable.querySelectorAll(".makeCurrentBtn").forEach(btn=>{
        btn.onclick=()=>{ const i=parseInt(btn.getAttribute("data-i")); currentUser=users[i]; save("currentUser",currentUser); applyPermissions(); renderAll(); alert(`Signed in as ${currentUser.name} (${currentUser.role})`); };
      });
      userTable.querySelectorAll(".removeUserBtn").forEach(btn=>{
        btn.onclick=()=>{ const i=parseInt(btn.getAttribute("data-i")); if(!confirm(`Remove user "${users[i].name}"?`)) return;
          const removed=users.splice(i,1)[0]; save("users",users);
          if(removed.name===currentUser.name){ currentUser=users[0]||{name:"Admin",role:"admin"}; save("currentUser",currentUser); }
          renderUsers(); applyPermissions(); renderAll();
        };
      });
    }
  }
  addUserBtn.onclick=()=>{
    if(!isAdmin()) return;
    const name=userNameInput.value.trim(); const role=userRoleInput.value;
    if(!name) return;
    if(users.find(u=>u.name.toLowerCase()===name.toLowerCase())) return alert("User already exists.");
    users.push({name,role}); save("users",users);
    if(!employees.includes(name)){ employees.push(name); save("employees",employees); }
    userNameInput.value=""; renderUsers(); renderEmployeeList(); renderSettings();
  };

  /* ======= Permissions & Visibility ======= */
  function applyPermissions(){
    updateUserHeader();
    // Sidebar visibility
    document.querySelector('[data-page="reports"]').classList.toggle("hidden", !isAdmin());
    document.querySelector('[data-page="settings"]').classList.toggle("hidden", !isAdmin());

    // Dashboard controls
    const nameWritable = isAdmin();
    nameInput.disabled = !nameWritable;
    if(isEmployee()){ nameInput.value=currentUser.name; }

    // Import/Export visibility
    downloadBtn.disabled = !isAdmin();
    importLabel.classList.toggle("hidden", !isAdmin());
    actionsHeader.classList.toggle("hidden", !isAdmin());

    // Help text
    dashboardHelp.textContent = isEmployee()
      ? "You are signed in as Employee. You can add entries for yourself only, and view only your records."
      : "";

    // Attendance controls set elsewhere (renderEmployeeList/openEmployeePanel)
  }

  /* ======= Initial render ======= */
  function renderAll(){ renderTable(); renderEmployeeList(); renderSettings(); renderUsers(); refreshEmployeeListForReports(); }
  applyPermissions();
  renderAll();
});
</script>
</body>
</html>
